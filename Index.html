<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎓 Fiches Employés</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'Roboto', sans-serif;
  background: #f5f7fb;
  color: #2b3a67;
  transition: background 0.5s, color 0.5s;
}

/* Mode sombre */
body.dark-mode {
  background: #1c1c2c;
  color: #f0f0f5;
}
body.dark-mode header {
  background: linear-gradient(135deg,#2c2c54,#3c3c8a);
}
body.dark-mode .nav-item { color: #ccc; }
body.dark-mode .nav-item.active::after { background: #a6a6ff; }
body.dark-mode input {
  background: #2a2a3b;
  color: #fff;
  border-color: #444;
}
body.dark-mode .employee-card { background: #2a2a3b; color: #f0f0f5; }

/* HEADER */
header {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: white;
  padding: 30px 20px 10px;
  text-align: center;
  border-bottom-left-radius: 40px;
  border-bottom-right-radius: 40px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  position: relative;
}
header h1 { font-size: 2.5rem; margin: 0; }
header p { margin-top: 8px; font-size: 1.05rem; color: #e0e0ff; }

/* Lune */
#moon {
  position: absolute;
  top: 20px;
  right: 25px;
  font-size: 1.8rem;
  cursor: pointer;
  transition: transform 0.5s;
}
#moon.rotate { transform: rotate(360deg); }

/* NAVIGATION */
#main-nav {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 20px;
}
.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: #fff;
  cursor: pointer;
  padding: 8px 0;
  transition: color 0.3s ease;
}
.nav-item:hover { color: #dcdcff; }
.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: #fff;
  border-radius: 5px;
  transition: width 0.3s ease;
}
.nav-item.active::after {
  width: 100%;
}

/* TABS */
#tab-contents .tab {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.4s ease, transform 0.4s ease;
}
#tab-contents .tab.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* BARRE DE RECHERCHE */
#search-container {
  margin: 30px auto 10px;
  text-align: center;
}
#search-bar {
  padding: 10px 15px;
  border-radius: 25px;
  border: 2px solid #667eea;
  width: 300px;
  font-size: 1rem;
  transition: all 0.3s ease;
}
#search-bar:focus {
  outline: none;
  border-color: #764ba2;
  box-shadow: 0 0 10px rgba(118,75,162,0.4);
}

/* EMPLOYÉS */
#employee-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 25px;
  padding: 20px;
}
.employee-card {
  background: #ffffff;
  border-radius: 20px;
  padding: 20px;
  width: 220px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 5px 15px rgba(0,0,0,0.07);
  position: relative;
}
.employee-card:hover {
  transform: translateY(-5px) scale(1.03);
  box-shadow: 0 12px 25px rgba(0,0,0,0.12);
}
.employee-name { font-weight: 700; font-size: 1.2rem; margin-bottom: 5px; }
.employee-grade { font-weight: 500; color: #787878; }

/* Anim sanctions */
@keyframes pulse {
  0%, 100% { transform: scale(1); box-shadow: 0 5px 15px rgba(0,0,0,0.07); }
  50% { transform: scale(1.05); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
}
.employee-card.pulse { animation: pulse 1.5s infinite; }

/* DETAILS EMPLOYÉ */
#employee-details {
  display: none;
  background: #ffffff;
  color: #2b3a67;
  padding: 25px 30px;
  border-radius: 25px;
  max-width: 720px;
  margin: 40px auto;
  box-shadow: 0 15px 30px rgba(0,0,0,0.08);
  border-top: 6px solid #667eea;
  position: relative;
}
#employee-details .close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 1.5rem;
  font-weight: bold;
  color: #667eea;
  cursor: pointer;
}
#employee-details .close-btn:hover { color: #764ba2; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; }
td { padding: 10px; border-bottom: 1px solid #eee; }
td:first-child { font-weight: 600; color: #2b3a67; }

/* Responsive */
@media (max-width: 650px){
  #search-bar { width: 80%; }
  .employee-card { width: 90%; }
  #employee-details { width: 90%; }
}
</style>
</head>
<body>

<header>
  <h1>🔥​Paleto Garage</h1>
  <p>Ce site est soumis à des droits d'auteur, By Artonn</p>
  <div id="moon">🌙</div>

  <nav id="main-nav">
    <div class="nav-item active" data-tab="accueil">Accueil</div>
    <div class="nav-item" data-tab="employe">Employé</div>
    <div class="nav-item" data-tab="recrutement">Recrutement</div>
    <div class="nav-item" data-tab="absence">Absence</div>
  </nav>
</header>

<div id="tab-contents">
  <div class="tab active" id="tab-accueil">
    <p style="text-align:center;margin-top:40px;">Bienvenue sur la page d'accueil ! Utilisez le menu pour naviguer entre les sections.</p>
  </div>

  <div class="tab" id="tab-employe">
    <div id="search-container">
      <input type="text" id="search-bar" placeholder="Rechercher un employé...">
    </div>
    <div id="employee-list"></div>
    <div id="employee-details"></div>
  </div>

  <div class="tab" id="tab-recrutement">
    <p style="text-align:center;margin-top:40px;">Contenu Recrutement ici</p>
  </div>
  <div class="tab" id="tab-absence">
    <p style="text-align:center;margin-top:40px;">Contenu Absence ici</p>
  </div>
</div>

<script>
// === Navigation entre les onglets ===
document.querySelectorAll('#main-nav .nav-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    document.querySelectorAll('#main-nav .nav-item').forEach(i=>i.classList.remove('active'));
    item.classList.add('active');
    const tab = item.dataset.tab;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
  });
});

// === Lune : animation + mode sombre ===
const moon=document.getElementById("moon");
moon.addEventListener("click",()=>{
  document.body.classList.toggle("dark-mode");
  moon.classList.add("rotate");
  setTimeout(()=>moon.classList.remove("rotate"),600);
});

// === Google Sheets ===
const SHEET_ID="17ZntDHZ8olidnCM1pig311AcjawM4l6HoRxSYFP7KGw";
const API_KEY="AIzaSyBtOfa8W5POpJ2KOZSKqxsC4CfZBkYG40E";
const SHEET_NAME="Info Employé";
let allEmployees=[],filteredEmployees=[];

async function loadEmployees(){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_NAME)}?key=${API_KEY}`;
  const res=await fetch(url);
  const data=await res.json();
  if(!data.values){ document.getElementById("employee-list").innerHTML="<p>Aucune donnée trouvée.</p>"; return; }

  const rows=data.values.filter(r=>r.some(c=>c.trim()!==""));
  const firstRowIsHeader=rows[0].some(v=>v.match(/[A-Za-z]/));
  const dataRows=firstRowIsHeader?rows.slice(1):rows;

  const unique=new Set();
  allEmployees=dataRows.map(r=>({
    id:r[1]||"", nom:r[2]||"", rib:r[3]||"", grade:r[4]||"", tel:r[5]||"",
    discord:r[6]||"", gmail:r[8]||"", diplome:r[9]||"", entree:r[10]||"",
    sortie:r[11]||"", sanction:r[12]||"", retrait:r[13]||""
  })).filter(e=>{
    if(!e.nom.trim() || e.nom==="Prénom / Nom" || e.nom==="Démission/Licenciement" || unique.has(e.nom)) return false;
    unique.add(e.nom);
    return true;
  });

  filteredEmployees=[...allEmployees];
  displayEmployeeList(filteredEmployees);
}

// === Affichage des cartes employés ===
function displayEmployeeList(employees){
  const list=document.getElementById("employee-list");
  list.innerHTML="";
  employees.forEach((emp,i)=>{
    const card=document.createElement("div");
    card.className="employee-card";

    // ✅ couleurs et effet impulsion selon sanction
    if(emp.sanction==="Avertissement 1"){
      card.style.background="linear-gradient(145deg,#FFD700,#FFC107)";
      card.classList.add("pulse");
    } else if(emp.sanction==="Avertissement 2"){
      card.style.background="linear-gradient(145deg,#FF8C00,#FF7F50)";
      card.classList.add("pulse");
    } else if(emp.sanction==="Licenciement"){
      card.style.background="linear-gradient(145deg,#FF3333,#CC0000)";
      card.classList.add("pulse");
    }

    card.innerHTML=`<div class="employee-name">${emp.nom}</div><div class="employee-grade">${emp.grade}</div>`;
    card.addEventListener("click",()=>showDetails(i));
    list.appendChild(card);
  });
}

document.getElementById("search-bar").addEventListener("input",e=>{
  const val=e.target.value.toLowerCase();
  filteredEmployees=allEmployees.filter(emp=>emp.nom.toLowerCase().includes(val));
  displayEmployeeList(filteredEmployees);
});

// === Détails employés ===
function showDetails(index){
  const emp = filteredEmployees[index];
  document.getElementById("employee-list").style.display = "none";
  const details = document.getElementById("employee-details");
  details.style.display = "block";

  const grades = [
    "Patron","Co Patron","DRH","RH","Responsable D'atelier",
    "Chef d'atelier","Confirmé","Mécano","Apprenti","Stagiaire"
  ];

  // === Diplômes ===
  let diplomeHTML = "";
  if (emp.diplome) {
    const links = emp.diplome.split(/\s+/).filter(l => l.startsWith("http"));
    diplomeHTML = links.map((link,i)=>{
      const label = links.length === 1 ? "Diplôme" : `Diplôme ${i+1}`;
      return `<button class="diplome-btn" onclick="openDiplomePopup('${link}')">🎓 ${label}</button>`;
    }).join("");
  } else {
    diplomeHTML = "<em>Aucun diplôme enregistré</em>";
  }

  // === Menu déroulant de grade ===
  const gradeOptions = grades.map(g => 
    `<option value="${g}" ${g === emp.grade ? "selected" : ""}>${g}</option>`
  ).join("");

  details.innerHTML = `
    <span class="close-btn" onclick="backToList()">✖</span>
    <h2>👤 ${emp.nom}</h2>
    <table>
      <tr><td>ID Unique</td><td>${emp.id}</td></tr>
      <tr><td>RIB</td><td>${emp.rib}</td></tr>
      <tr>
  <td>Grade</td>
  <td>
    <select id="grade-select" onchange="updateGrade('${emp.id}', this.value)">
      <option value="${emp.grade}" selected>${emp.grade}</option>
      <option value="Patron">Patron</option>
      <option value="Co Patron">Co Patron</option>
      <option value="DRH">DRH</option>
      <option value="RH">RH</option>
      <option value="Responsable D'atelier">Responsable D'atelier</option>
      <option value="Chef d'atelier">Chef d'atelier</option>
      <option value="Confirmé">Confirmé</option>
      <option value="Mécano">Mécano</option>
      <option value="Apprenti">Apprenti</option>
      <option value="Stagiaire">Stagiaire</option>
    </select>
  </td>
</tr>
      <tr><td>Numéro</td><td>${emp.tel}</td></tr>
      <tr><td>ID Discord</td><td>${emp.discord}</td></tr>
      <tr><td>Permis Gmail</td><td>${emp.gmail}</td></tr>
      <tr><td>🎓 Diplôme</td><td>${diplomeHTML}</td></tr>
      <tr><td>Date d'entrée</td><td>${emp.entree}</td></tr>
      <tr><td>Date de sortie</td><td>${emp.sortie}</td></tr>
      <tr><td>Avertissement / Licenciement</td><td>${emp.sanction}</td></tr>
      <tr><td>Date de retrait</td><td>${emp.retrait}</td></tr>
    </table>`;

  window.scrollTo({ top:0, behavior:"smooth" });
}

function backToList(){
  document.getElementById("employee-details").style.display="none";
  document.getElementById("employee-list").style.display="flex";
}

// === Popup pour afficher un diplôme Google Drive ===
function openDiplomePopup(url){
  const popup=document.createElement("div");
  popup.className="diplome-popup";
  popup.innerHTML=`
    <div class="popup-content">
      <span class="popup-close" onclick="this.parentElement.parentElement.remove()">✖</span>
      <iframe src="${url.replace('/view','/preview')}" frameborder="0" allowfullscreen></iframe>
    </div>`;
  document.body.appendChild(popup);
}

// === Affichage d'une notification visuelle ===
function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  // Animation d'apparition
  setTimeout(() => toast.classList.add("visible"), 50);

  // Disparition après 3 secondes
  setTimeout(() => {
    toast.classList.remove("visible");
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}

// === Mettre à jour le grade dans Google Sheets ===
async function updateGrade(empId, nouveauGrade) {
  const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: empId, grade: nouveauGrade })
    });

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      console.warn("Réponse non JSON :", text);
      showToast("⚠️ Réponse inattendue du serveur, mais la requête a été envoyée.", "warning");
      return;
    }

    if (data.success) {
      showToast("✅ Grade mis à jour avec succès !", "success");
    } else {
      showToast("❌ Erreur lors de la mise à jour : " + (data.error || "Erreur inconnue"), "error");
    }

  } catch (err) {
    console.error("Erreur réseau :", err);
    showToast("⚠️ Erreur réseau : impossible de contacter le serveur.", "error");
  }
}


loadEmployees();
</script>

<style>
/* === Boutons de diplôme plus modernes et discrets === */
.diplome-btn {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 10px;
  padding: 8px 16px;
  margin: 6px 4px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.95rem;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
}

.diplome-btn:hover {
  transform: translateY(-1px);
  background: linear-gradient(135deg, #8b80ff, #b48ef7);
  color: white;
  box-shadow: 0 8px 20px rgba(118, 75, 162, 0.3);
}

body.dark-mode .diplome-btn:hover {
  background: linear-gradient(135deg, #8b80ff, #b48ef7);
  color: white;
}


/* === Animation impulsion pour sanctions === */
@keyframes pulse {
  0%,100%{transform:scale(1);box-shadow:0 5px 15px rgba(0,0,0,0.07);}
  50%{transform:scale(1.05);box-shadow:0 12px 25px rgba(0,0,0,0.15);}
}
.employee-card.pulse{animation:pulse 1.5s infinite;}

/* === Popup diplôme === */
.diplome-popup {
  position: fixed;
  top:0;left:0;right:0;bottom:0;
  background: rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  animation: fadeIn 0.3s ease;
}
.popup-content {
  background:#fff;
  border-radius:0px;
  padding:0px;
  width: 100%;
  max-width:800px;
  height:80%;
  box-shadow:0 10px 25px rgba(0,0,0,0.4);
  position:relative;
  overflow:hidden;
}
.popup-content iframe {
  width:100%;
  height:100%;
  border:none;
  border-radius:0px;
}
.popup-close {
  position:absolute;
  top:8px;
  right:14px;
  font-size:1.6rem;
  cursor:pointer;
  color:#764ba2;
  transition:color 0.3s;
  font-weight:bold;
}
.popup-close:hover {color:#667eea;}
@keyframes fadeIn {from{opacity:0}to{opacity:1}}

/* === Notifications visuelles (toast) === */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #333;
  color: #fff;
  padding: 12px 18px;
  border-radius: 10px;
  font-size: 0.95rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.4s ease;
  z-index: 99999;
}
.toast.visible {
  opacity: 1;
  transform: translateY(0);
}

/* Variantes selon le type */
.toast.success { background: linear-gradient(135deg, #4CAF50, #45a049); }
.toast.error { background: linear-gradient(135deg, #e53935, #c62828); }
.toast.warning { background: linear-gradient(135deg, #ff9800, #f57c00); }
.toast.info { background: linear-gradient(135deg, #3f51b5, #5c6bc0); }

body.dark-mode .toast {
  color: #fff;
  box-shadow: 0 4px 15px rgba(255,255,255,0.1);
}

</style>
</body>
</html>
