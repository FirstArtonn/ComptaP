<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéì Fiches Employ√©s - Paleto Garage</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ==================== VARIABLES CSS ==================== */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
  --secondary-gradient: linear-gradient(135deg, #8b80ff, #b48ef7);
  --bg-light: #f5f7fb;
  --bg-dark: #1c1c2c;
  --card-light: #ffffff;
  --card-dark: #2a2a3b;
  --text-light: #2b3a67;
  --text-dark: #f0f0f5;
  --border-radius: 20px;
  --transition: all 0.3s ease;
  --header-height: 180px;
  --discord-blue: #5865F2;
}

/* ==================== BASE ==================== */
* { box-sizing: border-box; }

html { overflow-x: hidden; }

body {
  margin: 0;
  font-family: 'Roboto', sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  transition: background 0.5s, color 0.5s;
  overflow-x: hidden;
  padding-top: var(--header-height);
}

/* ==================== MODE SOMBRE ==================== */
body.dark-mode {
  background: var(--bg-dark);
  color: var(--text-dark);
}

body.dark-mode header { background: linear-gradient(135deg, #2c2c54, #3c3c8a); }
body.dark-mode .nav-item { color: #ccc; }
body.dark-mode .nav-item.active::after { background: #a6a6ff; }
body.dark-mode input,
body.dark-mode select {
  background: var(--card-dark);
  color: #fff;
  border-color: #444;
}
body.dark-mode input::placeholder { color: #aaa; }
body.dark-mode .employee-card,
body.dark-mode .recruit-card { 
  background: var(--card-dark); 
  color: var(--text-dark); 
}
body.dark-mode #employee-details,
body.dark-mode #recruit-details {
  background: var(--card-dark);
  color: var(--text-dark);
  border-top-color: #8b80ff;
}
body.dark-mode td { border-bottom-color: rgba(255,255,255,0.1); }
body.dark-mode td:first-child { color: #ddd; }
body.dark-mode .grade-wrapper button {
  background: rgba(255,255,255,0.08);
  color: #eaeaff;
  border-color: rgba(255,255,255,0.15);
}
body.dark-mode .grade-wrapper ul {
  background: rgba(255,255,255,0.08);
}
body.dark-mode .diplome-btn {
  background: rgba(255,255,255,0.08);
  border-color: rgba(255,255,255,0.15);
  color: #eee;
}
body.dark-mode .login-container {
  background: var(--card-dark);
}

/* ==================== HEADER ==================== */
header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--primary-gradient);
  color: white;
  padding: 30px 20px 10px;
  text-align: center;
  border-bottom-left-radius: 40px;
  border-bottom-right-radius: 40px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

header h1 { 
  font-size: clamp(1.5rem, 5vw, 2.5rem); 
  margin: 0; 
}

header p { 
  margin-top: 8px; 
  font-size: clamp(0.9rem, 2vw, 1.05rem); 
  color: #e0e0ff; 
}

#moon {
  position: absolute;
  top: 20px;
  right: 25px;
  font-size: 1.8rem;
  cursor: pointer;
  transition: transform 0.5s;
  user-select: none;
}
#moon.rotate { transform: rotate(360deg); }

/* Bouton User Profile */
#user-profile {
  position: absolute;
  top: 20px;
  right: 70px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  padding: 8px 15px;
  background: rgba(255,255,255,0.1);
  border-radius: 25px;
  transition: var(--transition);
  backdrop-filter: blur(5px);
}

#user-profile:hover {
  background: rgba(255,255,255,0.2);
}

#user-profile img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid white;
}

#user-profile .username {
  font-weight: 600;
  font-size: 0.95rem;
}

#logout-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 6px 12px;
  border-radius: 15px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: var(--transition);
  margin-left: 5px;
}

#logout-btn:hover {
  background: rgba(255,255,255,0.2);
}

/* ==================== LOGIN PAGE ==================== */
.login-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-light);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

.login-card {
  background: var(--card-light);
  border-radius: 25px;
  padding: 50px 40px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.15);
  text-align: center;
  max-width: 450px;
  width: 90%;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.login-card h1 {
  font-size: 2rem;
  margin-bottom: 10px;
  color: var(--text-light);
}

.login-card p {
  color: #666;
  margin-bottom: 30px;
  font-size: 1.05rem;
}

.discord-login-btn {
  background: var(--discord-blue);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  transition: var(--transition);
  box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
}

.discord-login-btn:hover {
  background: #4752C4;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(88, 101, 242, 0.6);
}

.discord-login-btn svg {
  width: 24px;
  height: 24px;
}

.login-info {
  margin-top: 30px;
  padding: 20px;
  background: rgba(88, 101, 242, 0.1);
  border-radius: 12px;
  color: #666;
  font-size: 0.9rem;
  line-height: 1.6;
}

body.dark-mode .login-card h1 {
  color: var(--text-dark);
}

body.dark-mode .login-card p,
body.dark-mode .login-info {
  color: #bbb;
}

/* ==================== NAVIGATION ==================== */
#main-nav {
  display: flex;
  justify-content: center;
  gap: clamp(20px, 5vw, 50px);
  margin-top: 20px;
  flex-wrap: wrap;
}

.nav-item {
  position: relative;
  font-weight: 600;
  font-size: 1.05rem;
  color: #fff;
  cursor: pointer;
  padding: 8px 0;
  transition: var(--transition);
  user-select: none;
}

.nav-item:hover { color: #dcdcff; }

.nav-item::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0%;
  height: 3px;
  background: #fff;
  border-radius: 5px;
  transition: width 0.3s ease;
}

.nav-item.active::after { width: 100%; }

/* Cacher les onglets selon permissions */
.nav-item.admin-only,
.nav-item.rh-only {
  display: none;
}

body.role-admin .nav-item.admin-only,
body.role-rh .nav-item.admin-only,
body.role-rh .nav-item.rh-only {
  display: block;
}

/* ==================== TABS ==================== */
.tab {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.4s ease, transform 0.4s ease;
}

.tab.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* ==================== BARRE DE RECHERCHE ==================== */
#search-container,
#search-container-recrutement {
  margin: 30px auto 10px;
  text-align: center;
}

#search-bar,
#search-bar-recrutement {
  padding: 12px 20px;
  border-radius: 25px;
  border: 2px solid #667eea;
  width: min(300px, 90%);
  font-size: 1rem;
  transition: var(--transition);
}

#search-bar:focus,
#search-bar-recrutement:focus {
  outline: none;
  border-color: #764ba2;
  box-shadow: 0 0 10px rgba(118,75,162,0.4);
}

/* ==================== CARTES EMPLOY√âS/RECRUTEMENT ==================== */
#employee-list,
#recruitment-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 25px;
  padding: 20px;
  min-height: 200px;
}

.employee-card,
.recruit-card {
  background: var(--card-light);
  border-radius: var(--border-radius);
  padding: 20px;
  width: 220px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 5px 15px rgba(0,0,0,0.07);
  position: relative;
}

.employee-card:hover,
.recruit-card:hover {
  transform: translateY(-5px) scale(1.03);
  box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}

.employee-name { 
  font-weight: 700; 
  font-size: 1.2rem; 
  margin-bottom: 5px; 
  word-break: break-word;
}

.employee-grade { 
  font-weight: 500; 
  color: #787878; 
}

body.dark-mode .employee-grade { color: #bbb; }

/* ==================== ANIMATIONS ==================== */
@keyframes pulse {
  0%, 100% { 
    transform: scale(1); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.07); 
  }
  50% { 
    transform: scale(1.05); 
    box-shadow: 0 12px 25px rgba(0,0,0,0.15); 
  }
}

.employee-card.pulse,
.recruit-card.pulse { 
  animation: pulse 1.5s infinite; 
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ==================== D√âTAILS ==================== */
#employee-details,
#recruit-details {
  display: none;
  background: var(--card-light);
  color: var(--text-light);
  padding: 25px 30px;
  border-radius: 25px;
  max-width: 720px;
  margin: 40px auto;
  box-shadow: 0 15px 30px rgba(0,0,0,0.08);
  border-top: 6px solid #667eea;
  position: relative;
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 1.5rem;
  font-weight: bold;
  color: #667eea;
  cursor: pointer;
  transition: var(--transition);
  user-select: none;
}

.close-btn:hover { color: #764ba2; }

table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 20px; 
}

td { 
  padding: 10px; 
  border-bottom: 1px solid rgba(0,0,0,0.08); 
  vertical-align: top;
}

td:first-child { 
  font-weight: 600; 
  color: var(--text-light); 
  width: 35%;
}

/* ==================== S√âLECTEUR DE GRADE ==================== */
.grade-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
  max-width: 220px;
}

.grade-wrapper button {
  width: 100%;
  padding: 12px 20px;
  font-size: 1rem;
  font-weight: 600;
  color: #2b3a67;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 12px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: var(--transition);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.grade-wrapper button:hover {
  background: var(--secondary-gradient);
  color: #fff;
  box-shadow: 0 8px 20px rgba(118,75,162,0.25);
}

.grade-wrapper button::after {
  content: '‚ñº';
  font-size: 0.8rem;
  color: #667eea;
  transition: transform 0.3s ease;
}

.grade-wrapper.open button::after {
  transform: rotate(180deg);
}

.grade-wrapper ul {
  position: absolute;
  top: calc(100% + 5px);
  left: 0;
  width: 100%;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  opacity: 0;
  z-index: 10;
}

.grade-wrapper.open ul {
  max-height: 500px;
  opacity: 1;
}

.grade-wrapper ul li {
  padding: 12px 20px;
  cursor: pointer;
  transition: var(--transition);
}

.grade-wrapper ul li:hover {
  background: var(--secondary-gradient);
  color: white;
}

/* ==================== BOUTONS DIPL√îME ==================== */
.diplome-btn {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 10px;
  padding: 8px 16px;
  margin: 6px 4px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.95rem;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
  display: inline-block;
}

.diplome-btn:hover {
  transform: translateY(-2px);
  background: var(--secondary-gradient);
  color: white;
  box-shadow: 0 8px 20px rgba(118, 75, 162, 0.3);
}

/* ==================== POPUP DIPL√îME ==================== */
.diplome-popup {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.popup-content {
  background: #fff;
  border-radius: 15px;
  padding: 0;
  width: 90%;
  max-width: 800px;
  height: 80%;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  position: relative;
  overflow: hidden;
}

.popup-content iframe {
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 15px;
}

.popup-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 1.8rem;
  cursor: pointer;
  color: #fff;
  background: rgba(0,0,0,0.5);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  z-index: 10000;
  backdrop-filter: blur(5px);
  user-select: none;
}

.popup-close:hover {
  background: rgba(0,0,0,0.7);
  transform: rotate(90deg);
}

/* ==================== TOAST NOTIFICATIONS ==================== */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #222;
  color: #fff;
  padding: 12px 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 15px;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s ease;
  z-index: 9999;
  max-width: 350px;
}

.toast.visible {
  opacity: 1;
  transform: translateY(0);
}

.toast.success { background: linear-gradient(135deg, #4CAF50, #45a049); }
.toast.error { background: linear-gradient(135deg, #e53935, #c62828); }
.toast.loading { background: linear-gradient(135deg, #2563eb, #1e40af); }
.toast.warning { background: linear-gradient(135deg, #ff9800, #f57c00); }

.spinner {
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}

/* ==================== MESSAGES INFO ==================== */
.info-message {
  text-align: center;
  padding: 40px 20px;
  font-size: 1.1rem;
  color: #667eea;
}

/* ==================== SELECT CUSTOM ==================== */
select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 2px solid #667eea;
  font-size: 1rem;
  cursor: pointer;
  transition: var(--transition);
  background: white;
}

select:focus {
  outline: none;
  border-color: #764ba2;
  box-shadow: 0 0 8px rgba(118,75,162,0.3);
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
  :root { --header-height: 220px; }
  
  header h1 { font-size: 1.8rem; }
  
  #main-nav { gap: 20px; }
  
  #user-profile {
    position: static;
    margin: 15px auto 0;
    width: fit-content;
  }
  
  #moon {
    right: 15px;
  }
  
  .employee-card,
  .recruit-card { width: calc(50% - 15px); }
  
  #employee-details,
  #recruit-details { 
    width: 95%; 
    margin: 20px auto;
    padding: 20px;
  }
  
  td:first-child { width: 40%; }
  
  .login-card {
    padding: 40px 30px;
  }
}

@media (max-width: 480px) {
  .employee-card,
  .recruit-card { width: 90%; }
  
  .toast {
    right: 10px;
    left: 10px;
    max-width: none;
  }
}

/* ==================== LOADING STATE ==================== */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(102, 126, 234, 0.3);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* ==================== ACCESS DENIED ==================== */
.access-denied {
  text-align: center;
  padding: 60px 20px;
  max-width: 500px;
  margin: 40px auto;
}

.access-denied h2 {
  font-size: 2rem;
  color: #ff6b6b;
  margin-bottom: 20px;
}

.access-denied p {
  color: #666;
  font-size: 1.1rem;
  line-height: 1.6;
}
</style>
</head>
<body>

<!-- ==================== LOGIN PAGE ==================== -->
<div class="login-container" id="login-container">
  <div class="login-card">
    <h1>üî• Paleto Garage</h1>
    <p>Connectez-vous avec Discord pour acc√©der au syst√®me de gestion</p>
    
    <button class="discord-login-btn" onclick="Auth.loginWithDiscord()">
      <svg viewBox="0 0 127.14 96.36" fill="currentColor">
        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
      </svg>
      Se connecter avec Discord
    </button>

    <div class="login-info">
      <strong>‚ÑπÔ∏è Information</strong><br>
      Vous devez √™tre membre du serveur Discord Paleto Garage pour acc√©der √† cette application.
      Les permissions sont bas√©es sur vos r√¥les Discord.
    </div>
  </div>
</div>

<!-- ==================== HEADER ==================== -->
<header id="main-header" style="display: none;">
  <h1>üî• Paleto Garage</h1>
  <p>Ce site est soumis √† des droits d'auteur, By Artonn</p>
  
  <div id="user-profile" style="display: none;">
    <img id="user-avatar" src="" alt="Avatar">
    <span class="username" id="user-name"></span>
    <button id="logout-btn" onclick="Auth.logout()">D√©connexion</button>
  </div>
  
  <div id="moon" title="Basculer mode sombre">üåô</div>

  <nav id="main-nav">
    <div class="nav-item active" data-tab="accueil">Accueil</div>
    <div class="nav-item" data-tab="employe">Employ√©s</div>
    <div class="nav-item rh-only" data-tab="recrutement">Recrutement</div>
    <div class="nav-item admin-only" data-tab="absence">Absence</div>
  </nav>
</header>

<!-- ==================== CONTENU ==================== -->
<div id="tab-contents" style="display: none;">
  <!-- ACCUEIL -->
  <div class="tab active" id="tab-accueil">
    <div style="text-align:center; margin-top:40px; padding: 20px;">
      <h2>üëã Bienvenue <span id="welcome-name"></span></h2>
      <p style="color: #666; max-width: 600px; margin: 20px auto;">
        Vous √™tes connect√© avec succ√®s. Utilisez le menu ci-dessus pour naviguer entre les diff√©rentes sections.
      </p>
      <div style="margin-top: 30px; padding: 20px; background: rgba(102,126,234,0.1); border-radius: 15px; max-width: 500px; margin: 30px auto;">
        <strong>Vos permissions :</strong>
        <p id="user-permissions" style="margin-top: 10px; color: #667eea;"></p>
      </div>
    </div>
  </div>

  <!-- EMPLOY√âS -->
  <div class="tab" id="tab-employe">
    <div id="search-container">
      <input type="text" id="search-bar" placeholder="üîç Rechercher un employ√©...">
    </div>
    <div id="employee-list"></div>
    <div id="employee-details"></div>
  </div>

  <!-- RECRUTEMENT -->
  <div class="tab" id="tab-recrutement">
    <div id="search-container-recrutement">
      <input type="text" id="search-bar-recrutement" placeholder="üîç Rechercher un candidat...">
    </div>
    <div id="recruitment-list"></div>
    <div id="recruit-details"></div>
  </div>

  <!-- ABSENCE -->
  <div class="tab" id="tab-absence">
    <div style="text-align:center; margin-top:40px; padding: 20px;">
      <h2>üìÖ Gestion des absences</h2>
      <p style="color: #666;">Cette section est en cours de d√©veloppement.</p>
    </div>
  </div>
</div>

<!-- ==================== JAVASCRIPT ==================== -->
<script>
'use strict';

// ==================== CONFIGURATION ====================
const CONFIG = {
  // Discord OAuth2
  DISCORD_CLIENT_ID: "comptap-production.up.railway.app", // √Ä REMPLACER
  DISCORD_REDIRECT_URI: window.location.origin + window.location.pathname,
  DISCORD_SCOPE: "identify guilds guilds.members.read",
  DISCORD_GUILD_ID: "978302300445614120", // √Ä REMPLACER
  
  // R√¥les Discord (IDs √† remplacer par vos vrais IDs de r√¥les)
  ROLES: {
    ADMIN: ["978302300466581508", "978302300466581507"], // Patron, Co-Patron
    RH: ["1214991274311032877", "1426932223722131606"], // DRH, RH
    EMPLOYEE: ["1358963448146296843"] // Tous les employ√©s
  },
  
  // Google Sheets
  SHEET_ID: "17ZntDHZ8olidnCM1pig311AcjawM4l6HoRxSYFP7KGw",
  API_KEY: "AIzaSyBtOfa8W5POpJ2KOZSKqxsC4CfZBkYG40E",
  SHEET_EMPLOYEES: "Info Employ√©",
  SHEET_RECRUITMENT: "Formulaire Info ",
  REFRESH_INTERVAL: 10000,
  GRADES: [
    "Patron", "Co Patron", "DRH", "RH", "Responsable D'atelier",
    "Chef d'atelier", "Confirm√©", "M√©cano", "Apprenti", "Stagiaire"
  ],
  DAYS: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"],
  SECTIONS_TO_IGNORE: ["DIRECTION", "SOUS-DIRECTION", "HAUT GRAD√â", "APPRENTI / M√âCANO/ CONFIRM√â / STAGIAIRES"]
};

// ==================== √âTAT GLOBAL ====================
const STATE = {
  user: null,
  userRole: null,
  allEmployees: [],
  filteredEmployees: [],
  allCandidates: [],
  filteredCandidates: [],
  currentTab: 'accueil'
};

// ==================== AUTHENTIFICATION DISCORD ====================
const Auth = {
  init() {
    // V√©rifier si on revient de Discord OAuth
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    
    if (code) {
      this.handleCallback(code);
    } else {
      // V√©rifier si d√©j√† connect√©
      const savedUser = this.loadUser();
      if (savedUser) {
        this.setUser(savedUser);
      } else {
        this.showLogin();
      }
    }
  },

loginWithDiscord() {
  // Rediriger vers le backend au lieu de Discord directement
  window.location.href = `${CONFIG.BACKEND_URL}/auth/discord`;
},

  async handleCallback(code) {
    try {
      Utils.showToast('‚è≥ Connexion en cours...', 'loading');
      
      // NOTE: Pour la s√©curit√©, cette partie devrait √™tre faite c√¥t√© serveur
      // Voici une version simplifi√©e pour d√©monstration
      
      // √âchanger le code contre un token (N√âCESSITE UN BACKEND)
      // const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {...});
      
      // Pour la d√©mo, on simule une connexion r√©ussie
      const mockUser = {
        id: '123456789',
        username: 'Demo User',
        discriminator: '1234',
        avatar: 'https://cdn.discordapp.com/embed/avatars/0.png',
        roles: CONFIG.ROLES.ADMIN, // Simuler un admin
        guild_member: true
      };
      
      // Retirer le code de l'URL
      window.history.replaceState({}, document.title, window.location.pathname);
      
      this.setUser(mockUser);
      Utils.showToast('‚úÖ Connexion r√©ussie !', 'success');
      
    } catch (error) {
      Utils.log('‚ùå', 'Erreur auth:', error);
      Utils.showToast('‚ùå Erreur de connexion', 'error');
      this.showLogin();
    }
  },

  async getUserInfo(token) {
    // R√©cup√©rer les infos utilisateur Discord
    const userResponse = await fetch('https://discord.com/api/users/@me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const user = await userResponse.json();

    // R√©cup√©rer les guilds de l'utilisateur
    const guildsResponse = await fetch('https://discord.com/api/users/@me/guilds', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const guilds = await guildsResponse.json();

    // V√©rifier que l'utilisateur est dans le bon serveur
    const inGuild = guilds.some(g => g.id === CONFIG.DISCORD_GUILD_ID);
    if (!inGuild) {
      throw new Error('Vous devez √™tre membre du serveur Discord Paleto Garage');
    }

    // R√©cup√©rer les r√¥les (n√©cessite un appel serveur avec bot token)
    // Pour la d√©mo, on simule
    user.roles = this.determineRole(user);
    user.guild_member = true;

    return user;
  },

  determineRole(user) {
    // Cette fonction devrait v√©rifier les vrais r√¥les Discord
    // Pour la d√©mo, on assigne admin
    return 'admin';
  },

  setUser(user) {
    STATE.user = user;
    STATE.userRole = this.getUserRole(user);
    
    // Sauvegarder en localStorage
    this.saveUser(user);
    
    // Afficher l'interface
    this.showApp();
    
    // Charger les donn√©es
    App.init();
  },

  getUserRole(user) {
    // D√©terminer le r√¥le bas√© sur les r√¥les Discord
    const userRoleIds = user.roles;
    
    if (CONFIG.ROLES.ADMIN.some(roleId => userRoleIds.includes(roleId))) {
      return 'admin';
    } else if (CONFIG.ROLES.RH.some(roleId => userRoleIds.includes(roleId))) {
      return 'rh';
    } else if (CONFIG.ROLES.EMPLOYEE.some(roleId => userRoleIds.includes(roleId))) {
      return 'employee';
    }
    
    return 'visitor';
  },

  showLogin() {
    document.getElementById('login-container').style.display = 'flex';
    document.getElementById('main-header').style.display = 'none';
    document.getElementById('tab-contents').style.display = 'none';
  },

  showApp() {
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('main-header').style.display = 'block';
    document.getElementById('tab-contents').style.display = 'block';
    
    // Afficher les infos utilisateur
    const user = STATE.user;
    document.getElementById('user-avatar').src = user.avatar;
    document.getElementById('user-name').textContent = `${user.username}#${user.discriminator}`;
    document.getElementById('user-profile').style.display = 'flex';
    document.getElementById('welcome-name').textContent = user.username;
    
    // Afficher les permissions
    const permissions = {
      'admin': 'Administrateur - Acc√®s complet',
      'rh': 'Ressources Humaines - Acc√®s aux employ√©s et recrutement',
      'employee': 'Employ√© - Consultation uniquement',
      'visitor': 'Visiteur - Acc√®s limit√©'
    };
    document.getElementById('user-permissions').textContent = permissions[STATE.userRole] || 'Aucune permission';
    
    // Ajouter la classe de r√¥le au body
    document.body.className = `role-${STATE.userRole}`;
    if (Utils.loadDarkMode()) {
      document.body.classList.add('dark-mode');
    }
  },

  logout() {
    localStorage.removeItem('discord_user');
    STATE.user = null;
    STATE.userRole = null;
    this.showLogin();
    Utils.showToast('üëã D√©connexion r√©ussie', 'success');
  },

  saveUser(user) {
    localStorage.setItem('discord_user', JSON.stringify(user));
  },

  loadUser() {
    const saved = localStorage.getItem('discord_user');
    return saved ? JSON.parse(saved) : null;
  },

  hasPermission(requiredRole) {
    const roleHierarchy = { 'admin': 3, 'rh': 2, 'employee': 1, 'visitor': 0 };
    return roleHierarchy[STATE.userRole] >= roleHierarchy[requiredRole];
  }
};

// ==================== UTILITAIRES ====================
const Utils = {
  getSheetUrl(sheetName) {
    return `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${CONFIG.API_KEY}`;
  },

  findHeaderIndex(rows, headerKeywords = ["ID Unique", "Pr√©nom / Nom"]) {
    for (let i = 0; i < rows.length; i++) {
      if (rows[i] && headerKeywords.some(keyword => 
        rows[i].some(cell => cell && cell.toString().includes(keyword))
      )) {
        return i;
      }
    }
    return -1;
  },

  sanitizeCell(cell) {
    return cell ? cell.toString().trim() : "";
  },

  isValidRow(row, nameIndex = 2) {
    const name = Utils.sanitizeCell(row[nameIndex]);
    return name && 
           name !== "Pr√©nom / Nom" && 
           name !== "D√©mission/Licenciement" &&
           !CONFIG.SECTIONS_TO_IGNORE.includes(name);
  },

  showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    if (type === 'loading') {
      toast.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
    } else {
      toast.textContent = message;
    }
    
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('visible'), 50);
    
    if (type !== 'loading') {
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 400);
      }, 3000);
    }
    
    return toast;
  },

  log(emoji, message, data) {
    console.log(`${emoji} ${message}`, data || '');
  },

  async fetchWithErrorHandling(url, options = {}) {
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return await response.json();
    } catch (error) {
      Utils.log('‚ùå', 'Erreur de chargement:', error);
      throw error;
    }
  },

  saveDarkMode(isDark) {
    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
  },

  loadDarkMode() {
    return localStorage.getItem('darkMode') === 'true';
  }
};

// ==================== NAVIGATION ====================
const Navigation = {
  init() {
    document.querySelectorAll('#main-nav .nav-item').forEach(item => {
      item.addEventListener('click', () => this.switchTab(item));
    });
  },

  switchTab(item) {
    document.querySelectorAll('#main-nav .nav-item').forEach(i => 
      i.classList.remove('active')
    );
    item.classList.add('active');

    const tabName = item.dataset.tab;
    STATE.currentTab = tabName;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');

    Utils.log('üìë', `Navigation vers: ${tabName}`);
  }
};

// ==================== MODE SOMBRE ====================
const DarkMode = {
  init() {
    const moon = document.getElementById('moon');
    
    if (Utils.loadDarkMode()) {
      document.body.classList.add('dark-mode');
    }

    moon.addEventListener('click', () => this.toggle(moon));
  },

  toggle(moon) {
    const isDark = document.body.classList.toggle('dark-mode');
    moon.classList.add('rotate');
    setTimeout(() => moon.classList.remove('rotate'), 600);
    Utils.saveDarkMode(isDark);
    Utils.log('üåô', `Mode sombre: ${isDark ? 'ON' : 'OFF'}`);
  }
};

// ==================== GESTION DES EMPLOY√âS ====================
const Employees = {
  async load() {
    if (!Auth.hasPermission('employee')) {
      document.getElementById('employee-list').innerHTML = '<div class="access-denied"><h2>üîí Acc√®s refus√©</h2><p>Vous n\'avez pas les permissions n√©cessaires pour voir cette section.</p></div>';
      return;
    }

    const list = document.getElementById('employee-list');
    
    try {
      list.innerHTML = '<p class="info-message">‚è≥ Chargement des employ√©s...</p>';
      
      const url = Utils.getSheetUrl(CONFIG.SHEET_EMPLOYEES);
      const data = await Utils.fetchWithErrorHandling(url);
      
      if (!data.values || data.values.length === 0) {
        list.innerHTML = '<p class="info-message" style="color:#ff6b6b;">‚ùå Aucune donn√©e trouv√©e.</p>';
        return;
      }

      const headerIndex = Utils.findHeaderIndex(data.values);
      if (headerIndex === -1) {
        list.innerHTML = '<p class="info-message" style="color:#ff6b6b;">‚ùå En-t√™te introuvable.</p>';
        return;
      }

      const dataRows = data.values.slice(headerIndex + 1);
      const unique = new Set();

      STATE.allEmployees = dataRows
        .filter(row => Utils.isValidRow(row, 2))
        .map(r => ({
          id: Utils.sanitizeCell(r[1]),
          nom: Utils.sanitizeCell(r[2]),
          rib: Utils.sanitizeCell(r[3]),
          grade: Utils.sanitizeCell(r[4]),
          tel: Utils.sanitizeCell(r[5]),
          discord: Utils.sanitizeCell(r[6]),
          gmail: Utils.sanitizeCell(r[8]),
          diplome: Utils.sanitizeCell(r[9]),
          entree: Utils.sanitizeCell(r[10]),
          sortie: Utils.sanitizeCell(r[11]),
          sanction: Utils.sanitizeCell(r[12]),
          retrait: Utils.sanitizeCell(r[13])
        }))
        .filter(e => {
          if (!e.nom || !e.id || unique.has(e.nom)) return false;
          unique.add(e.nom);
          return true;
        });

      Utils.log('‚úÖ', `Employ√©s charg√©s: ${STATE.allEmployees.length}`);
      STATE.filteredEmployees = [...STATE.allEmployees];
      this.display(STATE.filteredEmployees);

    } catch (error) {
      list.innerHTML = `
        <div class="info-message" style="color:#ff6b6b;">
          <p style="font-size:1.3rem; margin-bottom:10px;">‚ùå Erreur de chargement</p>
          <p>${error.message}</p>
        </div>
      `;
    }
  },

  display(employees) {
    const list = document.getElementById('employee-list');
    list.innerHTML = '';

    if (employees.length === 0) {
      list.innerHTML = '<p class="info-message">Aucun employ√© trouv√©.</p>';
      return;
    }

    employees.forEach((emp, index) => {
      const card = document.createElement('div');
      card.className = 'employee-card';
      card.setAttribute('data-id', emp.id);

      const sanctionStyles = {
        'Avertissement 1': { bg: 'linear-gradient(145deg,#FFD700,#FFC107)', pulse: true },
        'Avertissement 2': { bg: 'linear-gradient(145deg,#FF8C00,#FF7F50)', pulse: true },
        'Licenciement': { bg: 'linear-gradient(145deg,#FF3333,#CC0000)', pulse: true }
      };

      const style = sanctionStyles[emp.sanction];
      if (style) {
        card.style.background = style.bg;
        if (style.pulse) card.classList.add('pulse');
      }

      card.innerHTML = `
        <div class="employee-name">${emp.nom || 'Sans nom'}</div>
        <div class="employee-grade">${emp.grade || 'Sans grade'}</div>
      `;

      card.addEventListener('click', () => this.showDetails(index));
      list.appendChild(card);
    });
  },

  showDetails(index) {
    const emp = STATE.filteredEmployees[index];
    document.getElementById('employee-list').style.display = 'none';
    const details = document.getElementById('employee-details');
    details.style.display = 'block';

    let diplomeHTML = '<em>Aucun dipl√¥me</em>';
    if (emp.diplome) {
      const links = emp.diplome.split(/\s+/).filter(l => l.startsWith('http'));
      if (links.length > 0) {
        diplomeHTML = links.map((link, i) => {
          const label = links.length === 1 ? 'Dipl√¥me' : `Dipl√¥me ${i + 1}`;
          return `<button class="diplome-btn" onclick="Employees.openDiplome('${link}')">üéì ${label}</button>`;
        }).join('');
      }
    }

    // Afficher le s√©lecteur de grade uniquement si admin/RH
    let gradeHTML;
    if (Auth.hasPermission('rh')) {
      gradeHTML = `
        <div class="grade-wrapper">
          <button type="button">${emp.grade || 'S√©lectionner'}</button>
          <ul>
            ${CONFIG.GRADES.map(g => `
              <li onclick="Employees.updateGrade('${emp.id}','${g}')">${g}</li>
            `).join('')}
          </ul>
        </div>
      `;
    } else {
      gradeHTML = emp.grade || '-';
    }

    details.innerHTML = `
      <span class="close-btn" onclick="Employees.closeDetails()">‚úñ</span>
      <h2>üë§ ${emp.nom}</h2>
      <table>
        <tr><td>ID Unique</td><td>${emp.id || '-'}</td></tr>
        <tr><td>RIB</td><td>${emp.rib || '-'}</td></tr>
        <tr><td>Grade</td><td>${gradeHTML}</td></tr>
        <tr><td>T√©l√©phone</td><td>${emp.tel || '-'}</td></tr>
        <tr><td>Discord</td><td>${emp.discord || '-'}</td></tr>
        <tr><td>Gmail</td><td>${emp.gmail || '-'}</td></tr>
        <tr><td>üéì Dipl√¥me</td><td>${diplomeHTML}</td></tr>
        <tr><td>Date d'entr√©e</td><td>${emp.entree || '-'}</td></tr>
        <tr><td>Date de sortie</td><td>${emp.sortie || '-'}</td></tr>
        <tr><td>Sanction</td><td>${emp.sanction || '-'}</td></tr>
        <tr><td>Date retrait</td><td>${emp.retrait || '-'}</td></tr>
      </table>
    `;

    if (Auth.hasPermission('rh')) {
      document.querySelectorAll('.grade-wrapper').forEach(wrapper => {
        const btn = wrapper.querySelector('button');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.grade-wrapper').forEach(w => {
            if (w !== wrapper) w.classList.remove('open');
          });
          wrapper.classList.toggle('open');
        });
      });

      document.addEventListener('click', () => {
        document.querySelectorAll('.grade-wrapper').forEach(w => w.classList.remove('open'));
      });
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  },

  closeDetails() {
    document.getElementById('employee-details').style.display = 'none';
    document.getElementById('employee-list').style.display = 'flex';
  },

  openDiplome(url) {
    const popup = document.createElement('div');
    popup.className = 'diplome-popup';
    popup.innerHTML = `
      <div class="popup-content">
        <span class="popup-close" onclick="this.parentElement.parentElement.remove()">‚úñ</span>
        <iframe src="${url.replace('/view', '/preview')}" allowfullscreen></iframe>
      </div>
    `;
    document.body.appendChild(popup);
    popup.addEventListener('click', (e) => {
      if (e.target === popup) popup.remove();
    });
  },

  async updateGrade(empId, newGrade) {
    if (!Auth.hasPermission('rh')) {
      Utils.showToast('‚ùå Permission refus√©e', 'error');
      return;
    }

    const url = "https://script.google.com/macros/s/AKfycbx8UcKzySSIaXfkXCBFGz3Dj90lmJ2qZ-W5aiMLWy2dEU7gAXzvX-NOZ1hzGkLbVFwt/exec";
    const proxy = "https://corsproxy.io/?";
    
    const toast = Utils.showToast('‚è≥ Mise √† jour...', 'loading');

    try {
      await fetch(proxy + encodeURIComponent(url), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: empId, grade: newGrade })
      });

      const emp = STATE.allEmployees.find(e => e.id === empId);
      if (emp) {
        emp.grade = newGrade;
        const filtered = STATE.filteredEmployees.find(e => e.id === empId);
        if (filtered) filtered.grade = newGrade;
        
        document.querySelectorAll('.grade-wrapper button').forEach(btn => {
          btn.textContent = newGrade;
        });
      }

      toast.remove();
      Utils.showToast('‚úÖ Grade mis √† jour !', 'success');

    } catch (error) {
      toast.remove();
      Utils.showToast('‚ùå Erreur r√©seau', 'error');
      Utils.log('‚ùå', 'Erreur updateGrade:', error);
    }
  },

  setupSearch() {
    document.getElementById('search-bar').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      STATE.filteredEmployees = STATE.allEmployees.filter(emp =>
        emp.nom.toLowerCase().includes(query) ||
        emp.grade.toLowerCase().includes(query)
      );
      this.display(STATE.filteredEmployees);
    });
  },

  async refresh() {
    if (!Auth.hasPermission('employee')) return;
    
    try {
      const url = Utils.getSheetUrl(CONFIG.SHEET_EMPLOYEES);
      const data = await Utils.fetchWithErrorHandling(url);
      
      if (!data.values) return;

      const headerIndex = Utils.findHeaderIndex(data.values);
      if (headerIndex === -1) return;

      const dataRows = data.values.slice(headerIndex + 1);
      const unique = new Set();

      const latestEmployees = dataRows
        .filter(row => Utils.isValidRow(row, 2))
        .map(r => ({
          id: Utils.sanitizeCell(r[1]),
          nom: Utils.sanitizeCell(r[2]),
          rib: Utils.sanitizeCell(r[3]),
          grade: Utils.sanitizeCell(r[4]),
          tel: Utils.sanitizeCell(r[5]),
          discord: Utils.sanitizeCell(r[6]),
          gmail: Utils.sanitizeCell(r[8]),
          diplome: Utils.sanitizeCell(r[9]),
          entree: Utils.sanitizeCell(r[10]),
          sortie: Utils.sanitizeCell(r[11]),
          sanction: Utils.sanitizeCell(r[12]),
          retrait: Utils.sanitizeCell(r[13])
        }))
        .filter(e => {
          if (!e.nom || !e.id || unique.has(e.nom)) return false;
          unique.add(e.nom);
          return true;
        });

      STATE.allEmployees = latestEmployees;
      STATE.filteredEmployees = [...latestEmployees];

      latestEmployees.forEach(emp => {
        const card = document.querySelector(`.employee-card[data-id="${emp.id}"]`);
        if (card) {
          card.innerHTML = `
            <div class="employee-name">${emp.nom}</div>
            <div class="employee-grade">${emp.grade}</div>
          `;

          card.style.background = '';
          card.classList.remove('pulse');

          const sanctionStyles = {
            'Avertissement 1': { bg: 'linear-gradient(145deg,#FFD700,#FFC107)', pulse: true },
            'Avertissement 2': { bg: 'linear-gradient(145deg,#FF8C00,#FF7F50)', pulse: true },
            'Licenciement': { bg: 'linear-gradient(145deg,#FF3333,#CC0000)', pulse: true }
          };

          const style = sanctionStyles[emp.sanction];
          if (style) {
            card.style.background = style.bg;
            if (style.pulse) card.classList.add('pulse');
          }
        }
      });

    } catch (error) {
      Utils.log('‚ö†Ô∏è', 'Erreur refresh employ√©s:', error);
    }
  }
};

// ==================== GESTION DU RECRUTEMENT ====================
const Recruitment = {
  async load() {
    if (!Auth.hasPermission('rh')) {
      document.getElementById('recruitment-list').innerHTML = '<div class="access-denied"><h2>üîí Acc√®s refus√©</h2><p>Vous devez √™tre RH ou Administrateur pour acc√©der √† cette section.</p></div>';
      return;
    }

    const list = document.getElementById('recruitment-list');
    
    try {
      list.innerHTML = '<p class="info-message">‚è≥ Chargement des candidats...</p>';
      
      const url = Utils.getSheetUrl(CONFIG.SHEET_RECRUITMENT);
      const data = await Utils.fetchWithErrorHandling(url);
      
      if (!data.values || data.values.length === 0) {
        list.innerHTML = '<p class="info-message" style="color:#ff6b6b;">‚ùå Aucune donn√©e trouv√©e.</p>';
        return;
      }

      const headerIndex = Utils.findHeaderIndex(data.values, ["ID", "Pr√©nom", "Nom"]);
      if (headerIndex === -1) {
        list.innerHTML = '<p class="info-message" style="color:#ff6b6b;">‚ùå En-t√™te introuvable.</p>';
        return;
      }

      const dataRows = data.values.slice(headerIndex + 1);
      const unique = new Set();

      STATE.allCandidates = dataRows
        .map(r => ({
          id: Utils.sanitizeCell(r[3]),
          nom: Utils.sanitizeCell(r[4]),
          rib: Utils.sanitizeCell(r[5]),
          gmail: Utils.sanitizeCell(r[6]),
          tel: Utils.sanitizeCell(r[7]),
          discord: Utils.sanitizeCell(r[8]),
          permis: Utils.sanitizeCell(r[9]),
          diplome: Utils.sanitizeCell(r[11]),
          age: Utils.sanitizeCell(r[12]),
          carteIdentite: Utils.sanitizeCell(r[13]),
          motivations: Utils.sanitizeCell(r[14]),
          qualites: Utils.sanitizeCell(r[15]),
          dispo: [r[16], r[17], r[18], r[19], r[20], r[21], r[22]].map(d => Utils.sanitizeCell(d)),
          pourquoi: Utils.sanitizeCell(r[23]),
          illegal: Utils.sanitizeCell(r[24]),
          mecano: Utils.sanitizeCell(r[25]),
          statut: Utils.sanitizeCell(r[26]) || "En attente"
        }))
        .filter(c => {
          if (!c.nom || unique.has(c.nom)) return false;
          unique.add(c.nom);
          return true;
        })
        .reverse();

      Utils.log('‚úÖ', `Candidats charg√©s: ${STATE.allCandidates.length}`);
      STATE.filteredCandidates = [...STATE.allCandidates];
      this.display(STATE.filteredCandidates);

    } catch (error) {
      list.innerHTML = `
        <div class="info-message" style="color:#ff6b6b;">
          <p style="font-size:1.3rem; margin-bottom:10px;">‚ùå Erreur de chargement</p>
          <p>${error.message}</p>
        </div>
      `;
    }
  },

  display(candidates) {
    const list = document.getElementById('recruitment-list');
    list.innerHTML = '';

    if (candidates.length === 0) {
      list.innerHTML = '<p class="info-message">Aucun candidat trouv√©.</p>';
      return;
    }

    candidates.forEach((cand, index) => {
      const card = document.createElement('div');
      card.className = 'recruit-card';
      card.setAttribute('data-id', cand.id);

      const statusStyles = {
        'Accept√©': 'linear-gradient(145deg,#4CAF50,#45a049)',
        'Refus√©': 'linear-gradient(145deg,#FF3333,#CC0000)'
      };

      if (statusStyles[cand.statut]) {
        card.style.background = statusStyles[cand.statut];
      }

      card.innerHTML = `
        <div class="employee-name">${cand.nom}</div>
        <div class="employee-grade">${cand.statut}</div>
      `;

      card.addEventListener('click', () => this.showDetails(index));
      list.appendChild(card);
    });
  },

  showDetails(index) {
    const cand = STATE.filteredCandidates[index];
    document.getElementById('recruitment-list').style.display = 'none';
    const details = document.getElementById('recruit-details');
    details.style.display = 'block';

    const dispoHTML = cand.dispo
      .map((d, i) => d ? `<li>${CONFIG.DAYS[i]}: ${d}</li>` : '')
      .join('');

    details.innerHTML = `
      <span class="close-btn" onclick="Recruitment.closeDetails()">‚úñ</span>
      <h2>üë§ ${cand.nom}</h2>
      <table>
        <tr><td>ID Unique</td><td>${cand.id || '-'}</td></tr>
        <tr><td>RIB</td><td>${cand.rib || '-'}</td></tr>
        <tr><td>Gmail</td><td>${cand.gmail || '-'}</td></tr>
        <tr><td>T√©l√©phone</td><td>${cand.tel || '-'}</td></tr>
        <tr><td>Discord</td><td>${cand.discord || '-'}</td></tr>
        <tr><td>Permis</td><td>${cand.permis || '-'}</td></tr>
        <tr><td>Dipl√¥mes</td><td>${cand.diplome || '<em>Non renseign√©</em>'}</td></tr>
        <tr><td>√Çge</td><td>${cand.age || '-'}</td></tr>
        <tr><td>Carte d'identit√©</td><td>${cand.carteIdentite || '-'}</td></tr>
        <tr><td>Motivations</td><td>${cand.motivations || '-'}</td></tr>
        <tr><td>Qualit√©s / D√©fauts</td><td>${cand.qualites || '-'}</td></tr>
        <tr><td>Disponibilit√©s</td><td><ul style="list-style:none;padding:0">${dispoHTML || '<li>Non renseign√©es</li>'}</ul></td></tr>
        <tr><td>Pourquoi vous</td><td>${cand.pourquoi || '-'}</td></tr>
        <tr><td>Activit√© ill√©gale</td><td>${cand.illegal || '-'}</td></tr>
        <tr><td>Qu'est-ce qu'un m√©cano</td><td>${cand.mecano || '-'}</td></tr>
        <tr>
          <td>Statut</td>
          <td>
            <select onchange="Recruitment.updateStatus('${cand.id}', this.value)">
              <option value="En attente" ${cand.statut === 'En attente' ? 'selected' : ''}>En attente</option>
              <option value="Accept√©" ${cand.statut === 'Accept√©' ? 'selected' : ''}>Accept√©</option>
              <option value="Refus√©" ${cand.statut === 'Refus√©' ? 'selected' : ''}>Refus√©</option>
            </select>
          </td>
        </tr>
      </table>
    `;

    window.scrollTo({ top: 0, behavior: 'smooth' });
  },

  closeDetails() {
    document.getElementById('recruit-details').style.display = 'none';
    document.getElementById('recruitment-list').style.display = 'flex';
  },

  updateStatus(id, status) {
    const cand = STATE.allCandidates.find(c => c.id === id);
    if (cand) {
      cand.statut = status;
      const filtered = STATE.filteredCandidates.find(c => c.id === id);
      if (filtered) filtered.statut = status;
    }
    
    Utils.showToast(`Statut mis √† jour: ${status}`, 'success');
  },

  setupSearch() {
    document.getElementById('search-bar-recrutement').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      STATE.filteredCandidates = STATE.allCandidates.filter(c =>
        c.nom.toLowerCase().includes(query) ||
        c.statut.toLowerCase().includes(query)
      );
      this.display(STATE.filteredCandidates);
    });
  }
};

// ==================== APPLICATION PRINCIPALE ====================
const App = {
  async init() {
    Utils.log('üöÄ', 'Initialisation de l\'application...');

    Navigation.init();
    DarkMode.init();
    
    await Employees.load();
    await Recruitment.load();
    
    Employees.setupSearch();
    Recruitment.setupSearch();

    setInterval(() => {
      if (STATE.currentTab === 'employe') {
        Employees.refresh();
      }
    }, CONFIG.REFRESH_INTERVAL);

    Utils.log('‚úÖ', 'Application initialis√©e !');
  }
};

// ==================== D√âMARRAGE ====================
document.addEventListener('DOMContentLoaded', () => {
  Auth.init();
});
</script>

</body>
</html>

